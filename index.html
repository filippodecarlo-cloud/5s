<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>5S Workbench Surgery - Master Edition</title>
    <style>
        :root {
            --wood: #d4a373;
            --wood-dark: #9c6644;
            --primary: #1e293b;
            --accent: #2563eb;
            --success: #16a34a;
            --danger: #ef4444;
            --surface: #f8fafc;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background-color: var(--primary);
            color: #fff;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
            user-select: none;
        }

        /* --- UI Elements --- */
        header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(5px);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-sizing: border-box;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            z-index: 1000;
            height: 60px;
        }

        .header-left { display: flex; align-items: center; gap: 15px; }
        .hud { display: flex; gap: 20px; font-weight: bold; font-family: monospace; font-size: 1.2rem; }
        .hud-item span { color: var(--accent); }

        .btn-sm {
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 5px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex; align-items: center; gap: 5px;
            transition: background 0.2s;
        }
        .btn-sm:hover { background: rgba(255,255,255,0.25); }

        #game-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
            margin-top: 60px;
        }

        #workbench-container {
            position: relative;
            width: 900px;
            height: 550px; 
            background: var(--wood);
            border: 15px solid #5d4037;
            border-radius: 12px;
            box-shadow: 0 30px 60px rgba(0,0,0,0.5);
            overflow: hidden;
            background-image: repeating-linear-gradient(90deg, transparent 0, transparent 148px, rgba(0,0,0,0.05) 148px, rgba(0,0,0,0.05) 150px);
            transform-origin: center center;
        }

        /* --- Objects --- */
        .item {
            position: absolute;
            cursor: pointer;
            transition: transform 0.1s;
            filter: drop-shadow(2px 4px 6px rgba(0,0,0,0.3));
            touch-action: none;
            width: 70px;
            height: 70px;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 20; 
        }
        .item svg { width: 100%; height: 100%; pointer-events: none; }
        .item:hover { transform: scale(1.1); z-index: 100; }
        .item:active { transform: scale(0.95); }

        .shadow-slot {
            position: absolute;
            background: rgba(0,0,0,0.15);
            border: 2px dashed rgba(0,0,0,0.3);
            border-radius: 5px;
            pointer-events: none;
        }

        .stain {
            position: absolute;
            background: radial-gradient(circle, #2d2d2d 0%, rgba(45,45,45,0.8) 60%, transparent 100%);
            border-radius: 50%;
            cursor: crosshair;
            opacity: 0.9;
            transition: opacity 0.3s;
            z-index: 10;
        }
        .stain.passive { pointer-events: none; opacity: 0.5; z-index: 5; }
        
        .defect {
            position: absolute;
            width: 40px; height: 40px;
            cursor: pointer;
            display: none;
            z-index: 15;
            animation: pulse 1s infinite;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
        }
        .defect.found {
            animation: none; cursor: default; opacity: 1;
            border: 3px solid #16a34a !important;
            background: rgba(22, 163, 74, 0.2) !important;
        }
        @keyframes pulse { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }

        /* --- Legend Box (Phase 1 Bottom) --- */
        #seiri-legend {
            position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%);
            background: rgba(255,255,255,0.95); padding: 8px 15px; border-radius: 8px;
            display: flex; flex-direction: column; gap: 5px; font-size: 0.85rem; color: #333;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 200; width: 80%; text-align: center;
            pointer-events: none; 
        }
        .legend-row { display: flex; justify-content: center; align-items: center; gap: 5px; flex-wrap: wrap;}
        .legend-title { font-weight: bold; text-transform: uppercase; font-size: 0.75rem; margin-right: 5px; }
        .good-col { color: #166534; } .bad-col { color: #dc2626; }

        /* --- Modals & Overlays --- */
        #overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); display: flex; justify-content: center; align-items: center;
            z-index: 500; backdrop-filter: blur(8px);
        }
        .modal {
            background: white; color: var(--primary); padding: 2rem; border-radius: 12px;
            max-width: 500px; width: 90%; text-align: center;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5); animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        h2 { color: var(--accent); margin-top: 0; }
        p { color: #475569; line-height: 1.6; }
        .btn {
            background: var(--accent); color: white; border: none; padding: 12px 24px;
            font-size: 1.1rem; border-radius: 6px; cursor: pointer; font-weight: bold; margin-top: 15px;
            transition: all 0.2s;
        }
        .btn:hover { background: #1d4ed8; transform: translateY(-2px); }

        /* --- LEGEND MODAL SPECIFIC --- */
        #legend-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center;
            z-index: 1500; backdrop-filter: blur(5px);
        }
        .legend-modal {
            background: white; width: 90%; max-width: 600px; padding: 20px; border-radius: 12px;
            color: #333; text-align: center; max-height: 80vh; overflow-y: auto;
        }
        .legend-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 15px;
            margin-top: 20px; margin-bottom: 20px;
        }
        .legend-item { display: flex; flex-direction: column; align-items: center; font-size: 0.85rem; font-weight: 500; }
        .legend-item svg { width: 50px; height: 50px; margin-bottom: 5px; }

        /* --- Phase 4 UI --- */
        #seiketsu-ui {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); width: 80%; max-width: 600px;
            background: rgba(255,255,255,0.95); padding: 15px; border-radius: 8px; color: #333;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.2); text-align: center;
        }
        .label-options { display: flex; justify-content: center; gap: 10px; margin-top: 10px; }
        .label-opt {
            padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; text-align: center; width: 30%;
            transition: all 0.2s; display: flex; flex-direction: column; align-items: center; gap: 5px;
        }
        .label-opt:hover { border-color: var(--accent); background: #eff6ff; }
        .label-img { width: 100%; height: 40px; border: 1px solid #ccc; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; color: #666; background: white; border-radius: 4px; }

        /* --- Audit Flash --- */
        #flash-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: black; z-index: 400; display: none;
            color: white; font-size: 3rem; justify-content: center; align-items: center; font-weight: bold;
        }

        /* --- Notifications --- */
        #toast {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: var(--primary); color: white; padding: 12px 24px;
            border-radius: 30px; font-weight: bold; opacity: 0; transition: opacity 0.3s;
            pointer-events: none; z-index: 600; box-shadow: 0 5px 15px rgba(0,0,0,0.3); white-space: nowrap;
        }
        
        #hint-msg {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(239, 68, 68, 0.9); color: white; padding: 10px 20px;
            border-radius: 20px; font-weight: bold; display: none; z-index: 300;
            animation: pulse 1s infinite;
        }

    </style>
</head>
<body>

<header>
    <div class="header-left">
        <div>üîß The Workbench</div>
        <button class="btn-sm" onclick="toggleLegend()">
            ‚ùì Legenda
        </button>
    </div>
    <div class="hud">
        <div class="hud-item">Fase: <span id="phase-disp">Intro</span></div>
        <div class="hud-item">Tempo: <span id="time-disp">00:00</span></div>
    </div>
</header>

<div id="game-wrapper">
    <div id="workbench-container">
        <!-- Game Elements injected here -->
    </div>
    <div id="hint-msg">Trova l'anomalia nascosta!</div>
</div>

<!-- Main Game Modal -->
<div id="overlay">
    <div class="modal" id="modal-content"></div>
</div>

<!-- Dedicated Legend Modal -->
<div id="legend-overlay">
    <div class="legend-modal">
        <h2 style="margin-top:0; color:#1e293b;">Legenda Strumenti</h2>
        <div class="legend-grid" id="legend-grid-content"></div> <!-- RIMOSSO IL COMMENTO INTERNO -->
        <button class="btn" onclick="toggleLegend()">Chiudi</button>
    </div>
</div>

<div id="flash-overlay"></div>
<div id="toast">Feedback</div>

<script>
    /* --- ASSETS (SVG) --- */
    const ICONS = {
        // TOOLS
        hammer: `<svg viewBox="0 0 100 100"><rect x="45" y="40" width="10" height="55" fill="#5d4037"/><rect x="20" y="20" width="60" height="25" rx="2" fill="#ef4444"/><rect x="42" y="20" width="16" height="25" fill="#b91c1c"/></svg>`,
        wrench: `<svg viewBox="0 0 100 100"><path d="M60 40 L85 65 A5 5 0 0 1 80 75 L75 80 A5 5 0 0 1 65 85 L40 60 Z" fill="#94a3b8"/><circle cx="35" cy="35" r="15" fill="#cbd5e1" stroke="#64748b" stroke-width="4"/><path d="M28 28 L42 42" stroke="#64748b" stroke-width="2"/></svg>`,
        driver: `<svg viewBox="0 0 100 100"><rect x="45" y="50" width="10" height="45" fill="#f59e0b" rx="2"/><rect x="48" y="10" width="4" height="40" fill="#94a3b8"/><path d="M48 10 L52 10 L50 2 Z" fill="#64748b"/></svg>`,
        pliers: `<svg viewBox="0 0 100 100"><path d="M30 70 Q25 90 35 95 L45 60 L35 40 Q20 40 30 70 Z" fill="#3b82f6"/><path d="M70 70 Q75 90 65 95 L55 60 L65 40 Q80 40 70 70 Z" fill="#3b82f6"/><circle cx="50" cy="50" r="5" fill="#cbd5e1"/><path d="M35 40 L45 20 L55 20 L65 40" fill="#94a3b8"/></svg>`,
        saw: `<svg viewBox="0 0 100 100"><path d="M10 40 L30 40 L30 70 L80 70 L90 40 L10 40" fill="#cbd5e1"/><path d="M10 40 L30 40 L20 20 Z" fill="#dc2626"/><path d="M30 70 L80 70" stroke="#64748b" stroke-width="2" stroke-dasharray="2,2"/></svg>`,
        tape: `<svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="30" fill="#facc15" stroke="#eab308" stroke-width="3"/><rect x="70" y="45" width="20" height="10" fill="#facc15"/><rect x="85" y="45" width="5" height="15" fill="#000"/></svg>`,
        level: `<svg viewBox="0 0 100 100"><rect x="10" y="35" width="80" height="30" rx="2" fill="#22c55e"/><rect x="40" y="40" width="20" height="20" rx="10" fill="#ecfdf5"/><circle cx="50" cy="50" r="5" fill="#86efac"/></svg>`,
        cutter: `<svg viewBox="0 0 100 100"><rect x="30" y="30" width="40" height="60" fill="#f97316" rx="5"/><path d="M40 30 L40 10 L60 10 L60 30" fill="#94a3b8"/><path d="M45 10 L55 0 L55 10" fill="#cbd5e1"/></svg>`,
        spanner: `<svg viewBox="0 0 100 100"><path d="M20 20 L30 30 L70 30 L80 20" fill="none" stroke="#cbd5e1" stroke-width="12" stroke-linecap="round"/><path d="M20 20 L20 30" stroke="#cbd5e1" stroke-width="12"/><path d="M80 20 L80 30" stroke="#cbd5e1" stroke-width="12"/></svg>`,
        ruler: `<svg viewBox="0 0 100 100"><rect x="10" y="20" width="80" height="60" fill="#fde047" transform="rotate(-45 50 50)"/><line x1="20" y1="20" x2="20" y2="40" stroke="#000" stroke-width="1" transform="rotate(-45 50 50)"/></svg>`,

        // TRASH
        trash_can: `<svg viewBox="0 0 100 100"><path d="M30 30 L35 90 L65 90 L70 30 Z" fill="#ef4444"/><text x="35" y="60" font-size="12" fill="white" font-weight="bold">SODA</text></svg>`,
        trash_banana: `<svg viewBox="0 0 100 100"><path d="M20 80 Q50 90 80 20" stroke="#facc15" stroke-width="15" fill="none" stroke-linecap="round"/><line x1="20" y1="80" x2="25" y2="75" stroke="#a16207" stroke-width="5"/></svg>`,
        trash_gear: `<svg viewBox="0 0 100 100"><path d="M50 50 m-25 0 a 25 25 0 1 0 50 0 a 25 25 0 1 0 -50 0" fill="none" stroke="#475569" stroke-width="10" stroke-dasharray="10,5"/><circle cx="50" cy="50" r="10" fill="#475569"/></svg>`,
        
        // EXTRAS
        crack: `<svg viewBox="0 0 100 100"><path d="M10 10 L30 40 L20 60 L50 80 L80 90" fill="none" stroke="#ef4444" stroke-width="3" stroke-linecap="round"/></svg>`
    };

    const TOOL_LIST = ['hammer', 'wrench', 'driver', 'pliers', 'saw', 'tape', 'level', 'cutter', 'spanner', 'ruler'];
    const TOOL_NAMES = {
        hammer: "Martello",
        wrench: "Chiave Inglese",
        driver: "Cacciavite",
        pliers: "Pinza",
        saw: "Seghetto",
        tape: "Metro",
        level: "Livella",
        cutter: "Taglierino",
        spanner: "Chiave Fissa",
        ruler: "Squadra"
    };

    /* --- GAME STATE --- */
    const state = {
        phase: 0,
        startTime: 0,
        timerInterval: null,
        isPaused: false, // NEW: Pause state for legend
        
        layout: { tools: [], trash: [], stains: [] },

        remainingTrash: 0,
        placedTools: 0,
        cleanedSpots: 0,
        totalSpots: 6, 
        foundDefects: 0,
        totalDefects: 2,
        mistakes: 0
    };

    const els = {
        container: document.getElementById('workbench-container'),
        overlay: document.getElementById('overlay'),
        legendOverlay: document.getElementById('legend-overlay'),
        modal: document.getElementById('modal-content'),
        phase: document.getElementById('phase-disp'),
        time: document.getElementById('time-disp'),
        flash: document.getElementById('flash-overlay'),
        toast: document.getElementById('toast'),
        hint: document.getElementById('hint-msg')
    };

    /* --- LEGEND LOGIC --- */
    function toggleLegend() {
        if (els.legendOverlay.style.display === 'flex') {
            // Close Legend
            els.legendOverlay.style.display = 'none';
            state.isPaused = false;
        } else {
            // Open Legend
            const grid = document.getElementById('legend-grid-content');
            // Controllo pi√π robusto: se non ci sono figli (elementi), popola
            if (grid.children.length === 0) {
                grid.innerHTML = ''; // Pulisce eventuali spazi vuoti o testo
                TOOL_LIST.forEach(t => {
                    grid.innerHTML += `
                        <div class="legend-item">
                            <div style="width:50px; height:50px;">${ICONS[t]}</div>
                            <span style="margin-top:5px;">${TOOL_NAMES[t]}</span>
                        </div>
                    `;
                });
            }
            els.legendOverlay.style.display = 'flex';
            state.isPaused = true;
        }
    }

    /* --- RESPONSIVE --- */
    function resizeGame() {
        const baseW = 900;
        const baseH = 550;
        const availW = window.innerWidth - 20;
        const availH = window.innerHeight - 100; 
        const scale = Math.min(availW / baseW, availH / baseH, 1);
        els.container.style.transform = `scale(${scale})`;
    }
    window.addEventListener('resize', resizeGame);
    window.addEventListener('orientationchange', () => setTimeout(resizeGame, 200));
    setTimeout(resizeGame, 100);

    /* --- ENGINE --- */
    function initGame() {
        generateLevelLayout(); 
        showModal('intro');
    }

    function generateLevelLayout() {
        // Safe Zones: X 100-750, Y 80-380
        state.layout.tools = TOOL_LIST.map(t => ({
            type: t,
            x: Math.random() * 650 + 100, 
            y: Math.random() * 300 + 80,  
            rot: Math.random() * 360
        }));

        const trashTypes = ['trash_can', 'trash_banana', 'trash_gear', 'trash_can', 'trash_gear'];
        state.layout.trash = trashTypes.map(t => ({
            type: t,
            x: Math.random() * 650 + 100, 
            y: Math.random() * 300 + 80,  
            rot: Math.random() * 360
        }));

        state.layout.stains = [
            {x: 200, y: 120, size: 110, hasDefect: false},
            {x: 500, y: 100, size: 80, hasDefect: false},
            {x: 350, y: 300, size: 150, hasDefect: true},  
            {x: 120, y: 300, size: 80, hasDefect: false},
            {x: 700, y: 220, size: 110, hasDefect: true},  
            {x: 580, y: 320, size: 140, hasDefect: false}  
        ];
    }

    function startPhase(p) {
        state.phase = p;
        state.startTime = Date.now();
        state.isPaused = false;
        els.container.innerHTML = ''; 
        els.overlay.style.display = 'none';
        els.hint.style.display = 'none';
        
        const phaseNames = ["", "1. Seiri (Separare)", "2. Seiso (Pulire)", "3. Seiton (Ordinare)", "4. Seiketsu (Std)", "5. Shitsuke (Audit)"];
        els.phase.textContent = phaseNames[p];

        if(state.timerInterval) clearInterval(state.timerInterval);
        state.timerInterval = setInterval(() => {
            if (state.isPaused) {
                // Adjust start time so timer doesn't jump when unpaused
                state.startTime += 1000;
                return;
            }
            const s = Math.floor((Date.now() - state.startTime) / 1000);
            const m = Math.floor(s / 60);
            const sec = s % 60;
            els.time.textContent = `${m}:${sec.toString().padStart(2,'0')}`;
        }, 1000);

        if (p === 1) setupSeiri();
        else if (p === 2) setupSeiso();
        else if (p === 3) setupSeiton();
        else if (p === 4) setupSeiketsu();
        else if (p === 5) setupShitsuke();
    }

    function endPhase() {
        clearInterval(state.timerInterval);
        if (state.phase < 5) showModal('intermission', state.phase);
        else showModal('victory');
    }

    /* --- PHASE 1: SEIRI (Red Tag) --- */
    function setupSeiri() {
        state.layout.stains.forEach(s => {
            createStain(s.x, s.y, s.size, s.hasDefect, true); 
        });

        state.layout.tools.forEach(t => {
            spawnItem(t.type, t.x, t.y, 'good', t.rot);
        });

        state.remainingTrash = state.layout.trash.length;
        state.layout.trash.forEach(t => {
            spawnItem(t.type, t.x, t.y, 'bad', t.rot);
        });

        addLegend();
    }

    function addLegend() {
        const leg = document.createElement('div');
        leg.id = "seiri-legend";
        leg.innerHTML = `
            <div class="legend-row bad-col"><span class="legend-title">ELIMINA:</span> Lattina, Buccia, Ingranaggio</div>
            <div style="height:1px; background:#e2e8f0; width:100%; margin:2px 0;"></div>
            <div class="legend-row good-col"><span class="legend-title">TIENI:</span> Utensili (Vedi Legenda in alto)</div>
        `;
        els.container.appendChild(leg);
    }

    function handleSeiriClick(item, type, element) {
        if (state.isPaused) return; // Prevent clicks while legend is open
        if (type === 'bad') {
            element.style.transform = "scale(0) rotate(180deg)";
            setTimeout(() => element.remove(), 200);
            showToast("Red Tag! üóëÔ∏è", "success");
            state.remainingTrash--;
            if (state.remainingTrash <= 0) setTimeout(endPhase, 500);
        } else {
            showToast("No! √à uno strumento utile! ‚ö†Ô∏è", "danger");
            element.style.filter = "drop-shadow(0 0 10px red)";
            setTimeout(() => element.style.filter = "", 500);
            state.mistakes++;
        }
    }

    /* --- PHASE 2: SEISO (Clean) --- */
    function setupSeiso() {
        state.cleanedSpots = 0;
        state.foundDefects = 0;
        
        state.layout.tools.forEach(t => {
            spawnItem(t.type, t.x, t.y, 'static', t.rot);
        });

        state.layout.stains.forEach(s => {
            createStain(s.x, s.y, s.size, s.hasDefect, false);
        });
    }

    function createStain(x, y, size, hasDefect, isPassive) {
        const div = document.createElement('div');
        div.className = 'stain';
        if(isPassive) div.classList.add('passive');
        div.style.left = x + 'px'; div.style.top = y + 'px';
        div.style.width = size + 'px'; div.style.height = size + 'px';
        
        let defectEl = null;
        if (hasDefect && !isPassive) {
            defectEl = document.createElement('div');
            defectEl.className = 'defect';
            defectEl.innerHTML = ICONS.crack;
            defectEl.style.left = (x + size/2 - 20) + 'px'; 
            defectEl.style.top = (y + size/2 - 20) + 'px';
            
            defectEl.onclick = () => {
                if (state.isPaused) return;
                if (defectEl.classList.contains('found')) return;
                defectEl.classList.add('found');
                showToast("Difetto Confermato! ‚úÖ", "success");
                state.foundDefects++;
                checkSeisoCompletion();
            };
            els.container.appendChild(defectEl);
        }

        if (!isPassive) {
            div.onclick = () => {
                if (state.isPaused) return;
                div.style.opacity = 0;
                div.style.pointerEvents = 'none'; 
                setTimeout(() => div.remove(), 300);
                showToast("Pulito! ‚ú®", "success");
                state.cleanedSpots++;
                
                if (hasDefect && defectEl) {
                    defectEl.style.display = 'block'; 
                    showToast("ANOMALIA! Cliccala!", "danger");
                }
                checkSeisoCompletion();
            };
        }
        
        els.container.appendChild(div);
    }

    function checkSeisoCompletion() {
        if (state.cleanedSpots === state.totalSpots && state.foundDefects < state.totalDefects) {
            els.hint.style.display = 'block';
        } else {
            els.hint.style.display = 'none';
        }

        if (state.cleanedSpots === state.totalSpots && state.foundDefects === state.totalDefects) {
             setTimeout(endPhase, 1000);
        }
    }

    /* --- PHASE 3: SEITON (Order) --- */
    function setupSeiton() {
        const cols = 5;
        const startX = 60; const gapX = 160;
        const startY = 40; const gapY = 120;

        state.layout.tools.forEach((t, i) => {
            const row = Math.floor(i / cols);
            const col = i % cols;
            const x = startX + col * gapX;
            const y = startY + row * gapY;
            
            createShadow(t.type, x, y, 80, 80);
            spawnDraggable(t.type, Math.random()*700 + 50, Math.random()*150 + 320);
        });

        state.placedTools = 0;
    }

    function createShadow(type, x, y, w, h) {
        const div = document.createElement('div');
        div.className = 'shadow-slot';
        div.style.left = x + 'px'; div.style.top = y + 'px';
        div.style.width = w + 'px'; div.style.height = h + 'px';
        div.dataset.type = type;
        div.innerHTML = `<div style="opacity:0.2; width:100%; height:100%">${ICONS[type]}</div>`;
        els.container.appendChild(div);
    }

    function spawnDraggable(type, x, y) {
        const div = document.createElement('div');
        div.className = 'item draggable';
        div.innerHTML = ICONS[type];
        div.style.left = x + 'px'; div.style.top = y + 'px';
        div.dataset.type = type;
        div.style.zIndex = 50;
        
        div.onmousedown = startDrag;
        div.ontouchstart = startDrag;
        els.container.appendChild(div);
    }

    // Drag Logic
    let activeDrag = null;
    let dragStartMouseX, dragStartMouseY, dragStartItemX, dragStartItemY;

    function startDrag(e) {
        if (state.isPaused) return;
        e.preventDefault();
        activeDrag = e.currentTarget;
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        dragStartItemX = parseInt(activeDrag.style.left || 0);
        dragStartItemY = parseInt(activeDrag.style.top || 0);
        dragStartMouseX = clientX;
        dragStartMouseY = clientY;
        document.addEventListener('mousemove', doDrag);
        document.addEventListener('mouseup', stopDrag);
        document.addEventListener('touchmove', doDrag, {passive:false});
        document.addEventListener('touchend', stopDrag);
    }

    function doDrag(e) {
        if (!activeDrag) return;
        e.preventDefault();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        const style = window.getComputedStyle(els.container);
        const matrix = new WebKitCSSMatrix(style.transform);
        const scale = matrix.a || 1; 
        const deltaX = clientX - dragStartMouseX;
        const deltaY = clientY - dragStartMouseY;
        activeDrag.style.left = (dragStartItemX + deltaX/scale) + 'px';
        activeDrag.style.top = (dragStartItemY + deltaY/scale) + 'px';
    }

    function stopDrag(e) {
        if (!activeDrag) return;
        const toolRect = activeDrag.getBoundingClientRect();
        const toolCx = toolRect.left + toolRect.width/2;
        const toolCy = toolRect.top + toolRect.height/2;
        const shadows = document.querySelectorAll('.shadow-slot');
        let placed = false;

        shadows.forEach(shadow => {
            if (shadow.dataset.type === activeDrag.dataset.type) {
                const sRect = shadow.getBoundingClientRect();
                if (toolCx > sRect.left && toolCx < sRect.right && toolCy > sRect.top && toolCy < sRect.bottom) {
                    activeDrag.style.left = shadow.style.left;
                    activeDrag.style.top = shadow.style.top;
                    activeDrag.onmousedown = null; activeDrag.ontouchstart = null;
                    activeDrag.style.cursor = 'default';
                    showToast("OK! üëç", "success");
                    placed = true;
                    state.placedTools++;
                }
            }
        });

        if (!placed) showToast("Riprova...", "danger");
        activeDrag = null;
        document.removeEventListener('mousemove', doDrag);
        document.removeEventListener('mouseup', stopDrag);
        document.removeEventListener('touchmove', doDrag);
        document.removeEventListener('touchend', stopDrag);
        
        if (state.placedTools === TOOL_LIST.length) setTimeout(endPhase, 500);
    }

    /* --- PHASE 4: SEIKETSU --- */
    function setupSeiketsu() {
        const bin = document.createElement('div');
        bin.style.cssText = "position:absolute; left:50%; top:40%; transform:translate(-50%, -50%); width:400px; height:250px; background:#475569; border:4px solid #334155; border-radius:10px; display:flex; flex-wrap:wrap; justify-content:center; align-items:center; gap:10px;";
        
        const sampleTools = ['hammer', 'pliers', 'saw', 'tape'];
        sampleTools.forEach(t => {
            bin.innerHTML += `<div style="width:60px; height:60px;">${ICONS[t]}</div>`;
        });
        els.container.appendChild(bin);

        const ui = document.createElement('div');
        ui.id = "seiketsu-ui";
        ui.innerHTML = `
            <h3 style="margin:0 0 10px 0;">Scegli l'etichetta Standard:</h3>
            <div class="label-options">
                <div class="label-opt" onclick="checkLabel(1)"><div class="label-img" style="font-family:'Comic Sans MS'">MISTI</div><div style="font-size:0.7rem">Testo</div></div>
                <div class="label-opt" onclick="checkLabel(2)"><div class="label-img" style="background:yellow; font-weight:bold">X-99</div><div style="font-size:0.7rem">Codice</div></div>
                <div class="label-opt" onclick="checkLabel(3)"><div class="label-img" style="background:#2563eb; color:white; font-weight:bold; display:flex; gap:3px; padding:2px;"><span>üß∞</span> STD-KIT</div><div style="font-size:0.7rem">Visual</div></div>
            </div>
        `;
        els.container.appendChild(ui);
    }

    function checkLabel(opt) {
        if (state.isPaused) return;
        if (opt === 3) {
            showToast("Standard Corretto!", "success");
            setTimeout(endPhase, 1000);
        } else showToast("Non ottimale.", "danger");
    }

    /* --- PHASE 5: SHITSUKE (Audit) --- */
    function setupShitsuke() {
        renderAuditBoard(true); 
        const msg = document.createElement('div');
        msg.innerHTML = "Memorizza lo standard (3s)...";
        msg.style.cssText = "position:absolute; top:10px; left:50%; transform:translateX(-50%); color:white; font-size:1.5rem; background:rgba(0,0,0,0.5); padding:5px 15px; border-radius:8px;";
        els.container.appendChild(msg);

        setTimeout(() => { els.flash.style.display = 'flex'; els.flash.innerText = "AUDIT!"; }, 3000);
        setTimeout(() => {
            els.flash.style.display = 'none';
            els.container.innerHTML = '';
            renderAuditBoard(false); 
            const hint = document.createElement('div');
            hint.innerHTML = "Trova l'anomalia!";
            hint.style.cssText = "position:absolute; top:10px; left:50%; transform:translateX(-50%); color:#ef4444; font-size:1.5rem; background:rgba(255,255,255,0.9); padding:5px 15px; border-radius:8px; z-index:100;";
            els.container.appendChild(hint);
        }, 4500);
    }

    function renderAuditBoard(isPerfect) {
        const cols = 5;
        const startX = 60; const gapX = 160;
        const startY = 40; const gapY = 120;

        TOOL_LIST.forEach((tool, i) => {
            const row = Math.floor(i / cols);
            const col = i % cols;
            const x = startX + col * gapX;
            const y = startY + row * gapY;
            
            createShadow(tool, x, y, 80, 80);
            const item = createStaticItem(tool, x, y);
            
            if (!isPerfect && tool === 'hammer') {
                item.style.transform = "rotate(180deg)";
                item.style.filter = "sepia(1) hue-rotate(-50deg) saturate(3)";
                item.onclick = () => {
                    if (state.isPaused) return;
                    item.style.border = "3px solid red";
                    showToast("Anomalia Trovata!", "success");
                    setTimeout(endPhase, 1500);
                };
            }
            els.container.appendChild(item);
        });
    }

    function createStaticItem(type, x, y) {
        const div = document.createElement('div');
        div.innerHTML = ICONS[type];
        div.style.position = 'absolute';
        div.style.left = x + 'px'; div.style.top = y + 'px';
        div.style.width = '70px'; div.style.height = '70px';
        return div;
    }

    /* --- HELPERS --- */
    function spawnItem(type, x, y, logicType, rot=0) {
        const div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = ICONS[type];
        div.style.left = x + 'px'; div.style.top = y + 'px';
        div.style.transform = `rotate(${rot}deg)`;
        if (logicType !== 'static') div.onclick = () => handleSeiriClick(div, logicType, div);
        els.container.appendChild(div);
    }

    function showToast(msg, type) {
        els.toast.textContent = msg;
        els.toast.style.backgroundColor = type === 'success' ? 'var(--success)' : 'var(--danger)';
        els.toast.style.opacity = 1;
        setTimeout(() => els.toast.style.opacity = 0, 2000);
    }

    function showModal(type, phaseNum) {
        els.overlay.style.display = 'flex';
        let html = '';
        if (type === 'intro') {
            html = `<h2>üîß The Workbench</h2><p>5S Master Simulation</p><div style="text-align:left; background:#f1f5f9; padding:15px; border-radius:8px; font-size:0.9rem; margin-bottom:20px;"><strong>Obiettivo:</strong> Organizza i 10 strumenti.<br><strong>Regole:</strong> Clicca i rifiuti, Trascina gli attrezzi.</div><button class="btn" onclick="startPhase(1)">Inizia</button>`;
        } else if (type === 'intermission') {
            const texts = ["", "Rifiuti rimossi.", "Difetti segnalati!", "Tutto ordinato.", "Standard definito."];
            const btns = ["", "Avvia 2. Seiso", "Avvia 3. Seiton", "Avvia 4. Seiketsu", "Avvia 5. Shitsuke"];
            html = `<h2>Fase ${phaseNum} Completata</h2><p>${texts[phaseNum]}</p><button class="btn" onclick="startPhase(${phaseNum + 1})">${btns[phaseNum]}</button>`;
        } else if (type === 'victory') {
            html = `<h2 style="color:var(--success)">üèÜ Certificato 5S</h2><p>Hai organizzato perfettamente i 10 strumenti!</p><button class="btn" onclick="location.reload()">Rigioca</button>`;
        }
        els.modal.innerHTML = html;
    }

    initGame();
</script>
</body>
</html>